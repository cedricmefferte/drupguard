<div class="d-inline-flex ms-auto">
    <a href="{{ path('project_show', {'id': project.id}) }}" class="btn"><i class="fas fa-history"></i></a>
    <a href="{{ path('project_history', {'id': project.id}) }}" class="btn"><i class="fas fa-list"></i></a>
    {% if project.isWritable(user) %}
        <a href="{{ path('project_edit', {'id': project.id}) }}" class="btn"><i class="fas fa-edit"></i></a>
        {% if project.analyseQueue is not null or (project.lastAnalyse and project.lastAnalyse.running) %}
            <span><i class="fas fa-spinner fa-spin"></i></span>
        {% else %}
            <a href="{{ path('project_run', {'id': project.id}) }}" class="btn btn-run"><i class="fas fa-play"></i></a>
        {% endif %}
        <a href="{{ path('project_delete', {'id': project.id}) }}" class="btn"><i class="fas fa-trash"></i></a>
    {% endif %}
</div>
<script>
    var intervalCheck, timeoutAlert, alert;
    var startCheck = function () {
        intervalCheck = setInterval(function(){
            $.ajax({
                url: '{{ path('project_check', {'id': project.id}) }}'
            }).done(function(data) {
                if(!data.running && !data.pending) {
                    stopCheck();
                    document.location.reload();
                }
            });
        }, 5000);
    };
    var startAlert = function() {
        alert = $('<div class="alert alert-success alert-analyse-start" role="alert">Analyse is pending. This page will be refreshed automatically when finished.</div>')
        $('.alert-container').prepend(alert);
        timeoutAlert = setTimeout(function(){
            removeAlert(alert);
        }, 3000);
    };
    var stopCheck = function() {
        clearInterval(intervalCheck);
        clearTimeout(timeoutAlert);
    };
    var removeAlert = function (alert) {
        if(!alert) {
            return;
        }
        alert.fadeOut("normal", function() {
            $(this).remove();
            alert = null;
        });
    }

    {% if project.analyseQueue is not null or (project.lastAnalyse and project.lastAnalyse.running) %}
    $(document).ready(function() {
        startCheck();
        startAlert();
    });
    {% endif %}

    $(document).on('click', 'a.btn-run', function(e) {
        e.preventDefault();
        $('a.btn-run').replaceWith('<span><i class="fas fa-spinner fa-spin"></i></span>');
        startAlert();
        $.ajax({
            url: '{{ path('project_run', {'id': project.id}) }}'
        }).done(function() {
            startCheck();
        });
    });
</script>